<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Editor</title>
</head>
<body>
    <style>
        
        #question-list > li {
            border: 4px solid black;
            border-radius: 4px;
            padding: 10px;
            margin: 10px;
        }
        #question-text {
            display: block;
            box-sizing: border-box;
            resize: none;
            border: 2px solid black;
            border-radius: 4px;
            width: 100%;
        }
        #question-text[contenteditable]:empty::before {
            content: "Your question here...";
            color: gray;
        }
        #answer-list {
            padding: 0px 10px 10px 10px;
        }
        #answer-text {
            display: block;
            box-sizing: border-box;
            resize: none;
            border: 2px solid black;
            border-radius: 4px;
            width: 100%;
        }
        #answer-text[contenteditable]:empty::before {
            content: "Your answer here...";
            color: gray;
        }
    </style>

    <!-- Template for a question -->
    <template id="question-template">
        <label for="question-text">Question:</label>
        <span id="question-text" contenteditable role="textbox"></span>
        <div>Answers:</div>
        <ol type="a" id="answer-list">

        </ol>
        <button id="add-answer-button">Add answer</button>
        
        <br>
        <label for="axis-select">Select axis:</label>
        <select id="axis-select">
            <option value="">(add axis)</option>
        </select>
    </template>

    <!-- Template for an axis -->
    <template id="axis-template">
        <input type="text" id="axis-name" placeholder="ex. left-right, authoritarian-liberal" style="width: 100%" autocomplete="off">
    </template>

    <!-- Template for the answers and their point values -->
    <template id="answer-template">
        <label for="answer-value">Answer value:</label>
        <input type="number" placeholder="Value..." id="answer-value" style="width: 4em;" autocomplete="off">
        <span id="answer-text" contenteditable role="textbox"></span>
    </template>

    <!-- 
        The main HTML
    -->

    <span>Axis names:</span>
    <ul id="axis-list">
       <!--li>
        <input type="text" id="axis-name" placeholder="ex. left-right, authoritarian-liberal" style="width: 100%" autocomplete="off">
       </li...-->
    </ul>
    <button onclick="createAxis()">Add new axis</button>
    <button onclick="submitAxises()">Submit axises</button>
    <ol id="question-list">
        <!--li>
             <label for="question-text">Question:</label>
        <span id="question-text" contenteditable role="textbox"></span>
        <div>Answers:</div>
        <ol type="a" id="answer-list">
            <li>
                <label for="answer-value">Answer value:</label>
                <input type="number" placeholder="Value..." id="answer-value" style="width: 4em;" autocomplete="off">
                <span id="answer-text" contenteditable role="textbox"></span>
            </li...>
        </ol>
        <button id="add-answer-button">Add answer</button>
        
        <br>
        <label for="axis-select">Select axis:</label>
        <select id="axis-select">
            <option value="">(add axis)</option>
        </select>
        </li...-->
    </ol>
    <button onclick="createQuestion()">Add Question</button>
    <button onclick="readForm()">Read form</button>
    <button id="download">Download form in JSON</button>
   <script type="text/javascript">
        // Global variables
        const questionList = document.querySelector("#question-list")
        const axisList = document.querySelector("#axis-list")
        

        createQuestion()
        function createQuestion() {
            const li = questionList.appendChild(document.createElement("li"))
            li.classList.add("question-item")
            const template = document.querySelector("#question-template")
            li.appendChild(template.content.cloneNode(true))
            
            const addAnswerButton = li.querySelector("#add-answer-button")
            // Focus on the question input span element after creating a question
            li.querySelector("#question-text").focus()

            //Append previously applied axis names
            submitAxises()

            createAnswer(li.querySelector("#answer-list"))

            addAnswerButton.onclick = () => {
                createAnswer(li.querySelector("#answer-list"))
            }

        }

        function createAnswer(answerList) {
            const li = answerList.appendChild(document.createElement("li"))
            li.classList.add("answer-item")
            const template = document.querySelector("#answer-template")
            li.appendChild(template.content.cloneNode(true))
            li.querySelector("#answer-text").focus()
        }

        createAxis()
        function createAxis() {
            const li = axisList.appendChild(document.createElement("li"))
            li.classList.add("axis-item")
            const template = document.querySelector("#axis-template")
            li.appendChild(template.content.cloneNode(true))
            
            const input = li.querySelector("input")
            input.focus()
            input.addEventListener("keydown", event => {
                if (event.key === "Enter") {
                    submitAxises()
                    createAxis()
                }
            })
        }

        function submitAxises() {
            const selectArray = Array.from(document.querySelectorAll("select"))
            // Remove all existing children
            selectArray.forEach(select => {
                Array.from(select.children)?.forEach(option => option.remove())
            })
            const axises = Array.from(axisList.querySelectorAll("li"))
                .map(li => li.children[0].value)
            
            const select = document.createElement("select")
            
            axises.forEach(axis => {
                const option = select.appendChild(document.createElement("option"))
                option.innerHTML = axis
                option.value = axis
                
                selectArray.forEach(select => {
                    
                    select.appendChild(option.cloneNode(true))
                })
            })
            
        }

        class Question {
            constructor(questionText, Answers, axis) {
                this.questionText = questionText
                this.answers = answers
                this.axis = axis
            }
        }
        class Answer {
            constructor(answerText, value) {
                this.answerText = answerText
                this.value = value
            }
        }

        function readForm() {
            const questions = Array.from(questionList.querySelectorAll(".question-item"))
            console.log(questions.map(question => questionToObject(question)))
            return questions.map(question => questionToObject(question))
        }

        function questionToObject(question) {
            const answerList = Array.from(question.querySelectorAll(".answer-item"))
            const answers = answerList.map(li => {
                return {
                    answerText: li.querySelector("#answer-text").innerHTML,
                    value: li.querySelector("#answer-value").value
                }
            })

            return {
                questionText: question.querySelector("#question-text").innerHTML,
                axis: question.querySelector("#axis-select").value,
                answers: answers
            }
        }

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }
        
        const downloadButton = document.querySelector("#download")
        downloadButton.onclick = () => download("questions.json", JSON.stringify(readForm(), null, 2))
   </script>
</body>
</html>